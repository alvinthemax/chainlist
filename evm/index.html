<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Ethereum Chain — Giwa Network</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px;background:#f7fafc;color:#0f172a}
    .card{max-width:900px;margin:0 auto;background:white;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.08)}
    textarea{width:100%;height:160px;padding:12px;border-radius:8px;border:1px solid #e6eef6;font-family:monospace;resize:vertical}
    label{font-weight:600;margin-bottom:6px;display:block}
    .row{display:flex;gap:10px;align-items:center}
    button{background:#0ea5a0;border:none;padding:10px 16px;border-radius:8px;color:white;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    pre{background:#0f172a;color:#e6eef6;padding:12px;border-radius:8px;overflow:auto}
    .muted{color:#64748b;font-size:13px}
    .out{margin-top:12px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Add Chain to Wallet</h1>
    <p class="muted">Tempel JSON konfigurasi chain di bawah (atau gunakan tombol <em>Use example</em>), lalu klik <strong>Add Chain</strong> untuk memicu wallet seperti MetaMask.</p><label for="chainJson">Chain JSON</label>
<textarea id="chainJson" aria-label="Chain JSON"></textarea>

<div class="row out">
  <button id="useExample">Use example</button>
  <button id="addChainBtn">Add Chain</button>
  <button id="clearBtn">Clear</button>
</div>

<div class="out">
  <label>Status</label>
  <pre id="log">Ready.

Notes: • This page calls window.ethereum.request and requires a web3 wallet (e.g. MetaMask). • The JSON you paste can be either EIP-3085-format or the simpler format used earlier. • Example simple format keys supported: networkName, rpcUrl, chainId, currencySymbol, blockExplorerUrl • EIP-3085 full format supported too: chainId (hex or number), chainName, rpcUrls, nativeCurrency, blockExplorerUrls </pre> </div>

  </div>  <script>
    const textarea = document.getElementById('chainJson')
    const logEl = document.getElementById('log')
    const addBtn = document.getElementById('addChainBtn')
    const useExample = document.getElementById('useExample')
    const clearBtn = document.getElementById('clearBtn')

    const example = {
      "networkName": "Giwa Network",
      "rpcUrl": "https://sepolia-rpc.giwa.io",
      "chainId": 91342,
      "currencySymbol": "ETH",
      "blockExplorerUrl": "https://sepolia-explorer.giwa.io"
    }

    function log(...args){
      const time = new Date().toLocaleTimeString()
      logEl.textContent = `[${time}] ` + args.join(' ') + '\n' + logEl.textContent
    }

    useExample.addEventListener('click', ()=>{
      textarea.value = JSON.stringify(example, null, 2)
      log('Inserted example JSON')
    })

    clearBtn.addEventListener('click', ()=>{
      textarea.value = ''
      log('Cleared textarea')
    })

    function toHexChainId(value){
      // Accept number or hex string
      if (typeof value === 'number') return '0x' + value.toString(16)
      if (typeof value === 'string'){
        if (value.startsWith('0x')) return value
        // maybe decimal string
        const n = Number(value)
        if (!Number.isNaN(n)) return '0x' + n.toString(16)
        // fallback, return as-is
        return value
      }
      return value
    }

    function buildEip3085FromSimple(obj){
      // map the simple keys to EIP-3085 fields
      const chainId = obj.chainId ?? obj.chain_id
      const rpcUrl = obj.rpcUrl ?? obj.rpc_url ?? obj.rpcUrls ?? obj.rpc_url_s ?? obj.rpc
      const name = obj.networkName ?? obj.chainName ?? obj.chain_name
      const symbol = obj.currencySymbol ?? obj.nativeCurrency?.symbol ?? (obj.currency && obj.currency.symbol)
      const explorer = obj.blockExplorerUrl ?? obj.block_explorer_url ?? obj.blockExplorerUrls

      const params = {
        chainId: toHexChainId(chainId),
        chainName: name || 'Custom Network',
        rpcUrls: rpcUrl ? (Array.isArray(rpcUrl) ? rpcUrl : [rpcUrl]) : [],
        nativeCurrency: {
          name: symbol ? symbol : 'ETH',
          symbol: symbol ? symbol : 'ETH',
          decimals: 18
        },
        blockExplorerUrls: explorer ? (Array.isArray(explorer) ? explorer : [explorer]) : []
      }
      return params
    }

    async function addChain(){
      if (!window.ethereum){
        log('window.ethereum not found. Install MetaMask or another EIP-1193 wallet.')
        alert('No web3 wallet detected. Install MetaMask or use a compatible browser extension.')
        return
      }

      let userInput = textarea.value.trim()
      if (!userInput){ log('No input.'); alert('Paste a JSON configuration first.'); return }

      let parsed
      try{
        parsed = JSON.parse(userInput)
      }catch(e){
        log('JSON parse error:', e.message)
        alert('Invalid JSON. Check formatting in the textarea.')
        return
      }

      // If parsed already looks like EIP-3085, use it; otherwise convert
      let addParams
      if (parsed && (parsed.chainId && (parsed.rpcUrls || parsed.rpcUrl || parsed.rpc_urls)) ){
        // normalize
        addParams = {
          chainId: toHexChainId(parsed.chainId),
          chainName: parsed.chainName || parsed.networkName || 'Custom Network',
          rpcUrls: parsed.rpcUrls || (parsed.rpcUrl ? (Array.isArray(parsed.rpcUrl) ? parsed.rpcUrl : [parsed.rpcUrl]) : []),
          nativeCurrency: parsed.nativeCurrency || { name: parsed.currencyName || parsed.currencySymbol || 'ETH', symbol: parsed.currencySymbol || 'ETH', decimals: parsed.nativeCurrency?.decimals ?? 18 },
          blockExplorerUrls: parsed.blockExplorerUrls || (parsed.blockExplorerUrl ? (Array.isArray(parsed.blockExplorerUrl) ? parsed.blockExplorerUrl : [parsed.blockExplorerUrl]) : [])
        }
      } else {
        addParams = buildEip3085FromSimple(parsed)
      }

      // minimal validation
      if (!addParams.chainId || addParams.rpcUrls.length === 0){
        log('Missing chainId or rpcUrls in parsed params:', JSON.stringify(addParams))
        alert('Parsed configuration must include chainId and at least one rpcUrl.')
        return
      }

      log('Requesting wallet_addEthereumChain with:', JSON.stringify(addParams))
      addBtn.disabled = true
      try{
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [addParams]
        })
        log('Success: chain added or user approved addition')
        alert('Chain added (or approved) successfully.')
      }catch(err){
        // nicer error reporting for common cases
        log('Error', err && err.message ? err.message : err)
        if (err && err.code === 4001){
          log('User rejected the request (4001)')
          alert('Action rejected by user in wallet.')
        } else {
          alert('Failed to add chain. See console/log for details.\nError: ' + (err && err.message ? err.message : String(err)))
        }
      } finally {
        addBtn.disabled = false
      }
    }

    addBtn.addEventListener('click', addChain)

    // insert example by default (optional)
    textarea.value = JSON.stringify(example, null, 2)
  </script></body>
</html>
